<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مضمون</title>
  <style>
    /* ... [same CSS as your snippet, omitted for brevity] ... */
  </style>
</head>
<body>
  <div class="navbar">
    <a href="index.html">صفحہ اول</a>
    <a href="category.html?name=مصنفین">مصنفین</a>
    <a href="categories.html">زمرہ جات</a>
    <input type="search" id="searchBox" placeholder="تلاش کریں..." />
  </div>

  <div class="toggle-dark">
    <button onclick="document.body.classList.toggle('dark')">🌙 نائٹ موڈ</button>
  </div>

  <div class="container">
    <h1 id="title">مضمون</h1>
    <div class="meta">
      <strong>حوالہ:</strong> <span id="reference"></span><br />
      <strong>مصنف:</strong> <a id="author-link" href="#"></a>
    </div>

    <div id="bookContainer" class="book-pages"></div>
    <div class="nav-footer" id="relatedArticles"></div>
  </div>

  <!-- ✅ Supabase v2 client via CDN -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Initialize Supabase client FIRST
    const supabase = createClient(
      'https://npnjpcwqmfwwviqlwrvw.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbmpwY3dxbWZ3d3ZpcWx3cnZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTMyMzMsImV4cCI6MjA2ODY4OTIzM30.EEbXf-xsonUjvE0DZBOGcG9EU97aGNSUc6MRTEE40pU'
    );

    // Wait for DOM to be fully loaded (optional, but safe)
    document.addEventListener('DOMContentLoaded', () => {
      const articleId = new URLSearchParams(window.location.search).get('id');

      async function loadArticle() {
        if (!articleId) {
          document.getElementById('bookContainer').innerHTML = '<p>مضمون نہیں ملا۔</p>';
          return;
        }
        const { data: article, error } = await supabase
          .from('articles')
          .select(`id, title, reference, content, author_id, authors(id, name), created_at`)
          .eq('id', articleId)
          .single();

        if (error || !article) {
          document.getElementById('bookContainer').innerHTML = '<p>مضمون نہیں ملا۔</p>';
          return;
        }

        document.getElementById('title').textContent = article.title;
        document.getElementById('reference').textContent = article.reference || '';
        document.getElementById('author-link').textContent = article.authors?.name || 'نامعلوم';
        document.getElementById('author-link').href = `author.html?id=${article.author_id}`;

        const chunks = (article.content || '').match(/(.|[\r\n]){1,800}/g) || [];
        const container = document.getElementById('bookContainer');
        container.innerHTML = '';

        chunks.forEach((chunk, index) => {
          const page = document.createElement('div');
          page.className = 'page';
          page.innerHTML = chunk + `<div class="page-number">صفحہ ${index + 1}</div>`;
          container.appendChild(page);
        });

        loadRelated(article.author_id, article.id);
      }

      async function loadRelated(authorId, currentId) {
        const { data, error } = await supabase
          .from('articles')
          .select('id, title, created_at')
          .eq('author_id', authorId)
          .order('created_at', { ascending: true });

        if (error || !data) return;

        const index = data.findIndex(a => a.id == currentId);
        const prev = data[index - 1];
        const next = data[index + 1];

        const related = document.getElementById('relatedArticles');
        related.innerHTML = `
          ${prev ? `<a href="article.html?id=${prev.id}">← پچھلا مضمون</a>` : ''}
          &nbsp;&nbsp;&nbsp;
          ${next ? `<a href="article.html?id=${next.id}">اگلا مضمون →</a>` : ''}
        `;
      }

      document.getElementById('searchBox').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          const query = this.value.trim();
          if (query) {
            window.location.href = `search.html?q=${encodeURIComponent(query)}`;
          }
        }
      });

      loadArticle();
    });
  </script>
</body>
</html>
